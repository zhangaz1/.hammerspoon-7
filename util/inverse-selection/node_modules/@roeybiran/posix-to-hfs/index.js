const runApplescript = require('run-applescript');
const CacheConf = require('cache-conf');

const cache = new CacheConf();

/**
 * Convert POSIX paths to AppleScript-escaped HFS paths
 * @param {string[]} file - path to a file.
 * @returns {string[]}
 */
module.exports = async paths => {
  if (typeof paths === 'string')
    throw new TypeError('Excepted String[], got String');

  const output = [];
  let startupDisk = cache.get('startupDisk');
  if (!startupDisk) {
    startupDisk = await runApplescript(
      'tell application "System Events" to get name of startup disk'
    );
    cache.set('startupDisk', startupDisk);
  }

  paths.forEach(aPath => {
    // replace first / with the name of the startup disk
    let composedPath = startupDisk + aPath;
    // replace : with / and with versa, and escape "
    composedPath = composedPath
      .replace(/\/|:/g, aString => (aString === ':' ? '/' : ':'))
      .replace(/"/g, '\\"');
    output.push(composedPath);
  });
  return output;
};
